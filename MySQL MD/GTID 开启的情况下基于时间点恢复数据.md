添加一下配置，开启 gtid

> 源服务器和恢复服务器都需要开启

```
gtid_mode=on
enforce_gtid_consistency=on
```

源数据库操作数据

```
# 创建库表
create database test;
create table test.t(a datetime);

# 插入5条数据
insert into test.t values(now());
select * from test.t;
+---------------------+
| a                   |
+---------------------+
| 2023-10-16 14:40:07 |
| 2023-10-16 14:40:08 |
| 2023-10-16 14:40:09 |
| 2023-10-16 14:40:10 |
| 2023-10-16 14:40:11 |
+---------------------+

# 备份数据
mysqldump --databases test \
--triggers \
--routines \
--events \
--single-transaction \
--quick > test.sql

# 再插入5条数据
insert into test.t values(now());
select * from test.t;
+---------------------+
| a                   |
+---------------------+
| 2023-10-16 14:24:32 |
| 2023-10-16 14:24:32 |
| 2023-10-16 14:24:33 |
| 2023-10-16 14:24:34 |
| 2023-10-16 14:24:35 |
| 2023-10-16 14:27:39 |
| 2023-10-16 14:27:40 |
| 2023-10-16 14:27:41 |
| 2023-10-16 14:27:42 |
| 2023-10-16 14:27:43 |
+---------------------+

# 删除所有记录
delete from test.t;

# 查看 gtid
show master status;
```

将备份和 binlog 传到恢复服务器

```
scp test.sql 192.168.198.140:/tmp
scp /var/lib/mysql/binlog.000002 test.sql 192.168.198.140:/tmp
```

在恢复服务器还原数据

> 相同的 GTID 只会执行一遍

```
# 清除 gtid
reset master;

# 导入备份
mysql < test.sql

# 查看导入的结果
select * from test.t;
+---------------------+
| a                   |
+---------------------+
| 2023-10-16 14:40:07 |
| 2023-10-16 14:40:08 |
| 2023-10-16 14:40:09 |
| 2023-10-16 14:40:10 |
| 2023-10-16 14:40:11 |
+---------------------+

# 重放 binlog 到数据删除前的时间点
mysqlbinlog --stop-datetime="2023-10-16 14:41:42" --database=test binlog.000002 | mysql

# 查看恢复的数据
select * from test.t;
+---------------------+
| a                   |
+---------------------+
| 2023-10-16 14:40:07 |
| 2023-10-16 14:40:08 |
| 2023-10-16 14:40:09 |
| 2023-10-16 14:40:10 |
| 2023-10-16 14:40:11 |
| 2023-10-16 14:41:38 |
| 2023-10-16 14:41:38 |
| 2023-10-16 14:41:39 |
| 2023-10-16 14:41:40 |
| 2023-10-16 14:41:41 |
+---------------------+

# 查看 gtid
show master status;
```

