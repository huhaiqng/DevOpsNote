### 将 Innodb 表迁移到另一实例

在目标实例上创建数据库和表

```
create database sbtest;
use sbtest;
CREATE TABLE `sbtest6` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `k` int(10) unsigned NOT NULL DEFAULT '0',
  `c` char(120) NOT NULL DEFAULT '',
  `pad` char(60) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
);
```

在目标实例上释放表

```
ALTER TABLE sbtest.sbtest5 DISCARD TABLESPACE;
```

在源实例上生成源元数据文件 cfg

```
FLUSH TABLES sbtest.sbtest5 FOR EXPORT;
```

将 ibd 文件和  cfg 元数据文件从源实例复制到目标实例

```
cp sbtest.{ibd,cfg} /another mysql data dir/sbtest
```

在源实例上释放锁

```
use sbtest;
unlock tables;
```

在目标实例上，导入表空间

```
USE sbtest;
ALTER TABLE sbtest5 IMPORT TABLESPACE;
```



### 数据库备份方案

创建备份账号

```sql
mysql> create user backup@'%' identified by 'Yuh04j!w';
mysql> grant SELECT, SHOW VIEW, TRIGGER, EVENT, PROCESS on *.* TO backup@'%';
mysql> flush privileges;
```

备份脚本

```shell
#!/bin/bash
set -e
TIME_TAG=`date +%s`

function dumpdb() {
    # 创建备份目录
    [ ! -d $BACKUP_DIR ] && mkdir -pv $BACKUP_DIR
    cd $BACKUP_DIR
    # 获取需要备份的数据库名
    DBS=`mysql $SERVER_INFO -e 'show databases;' | grep -Ev 'information_schema|performance_schema|sys|Database'`
    echo -e "需要备份的数据库:\n$DBS"
    # 备份数据库
    for DB in $DBS
    do
        # 创建备份目录
        DB_DIR="$BACKUP_DIR/$DB"
        [ ! -d $DB_DIR ] && mkdir -pv $DB_DIR
        cd $DB_DIR 

        echo "开始备份数据库: $DB"
        mysqldump $SERVER_INFO $DB --triggers --routines --events --single-transaction --quick | gzip > $DB-${TIME_TAG}.gz
        # 删除过期备份
        rm -f `ls -t $DB-*.gz | tail -n +8`
    done
}

echo -e "\n开始备份 192.168.40.159 的数据库"
BACKUP_DIR="/data/backup/mysql/192.168.40.159"
SERVER_INFO="-h 192.168.40.159 -P 3306 -u backup -pWguJX78n"
dumpdb

echo -e "\n开始备份 192.168.40.185 的数据库"
BACKUP_DIR="/data/backup/mysql/192.168.40.185"
SERVER_INFO="-h 192.168.40.185 -P 3306 -u backup -pYuh04j!w"
dumpdb
```

